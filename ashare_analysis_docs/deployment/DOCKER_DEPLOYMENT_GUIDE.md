# Aè‚¡åˆ†æå¤šæ™ºèƒ½ä½“ç³»ç»ŸDockeréƒ¨ç½²æŒ‡å—

## æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›åŸºäºTradingAgents-CNé¡¹ç›®çš„Aè‚¡åˆ†æå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å®Œæ•´Dockeréƒ¨ç½²æ–¹æ¡ˆã€‚ç³»ç»ŸåŒ…å«å¤šä¸ªåˆ†æAgentã€å¤šå±‚ç¼“å­˜æ¶æ„ã€å¤šLLMæ”¯æŒï¼Œå¹¶é›†æˆäº†å®Œæ•´çš„æ•°æ®æºç³»ç»Ÿã€‚

## ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  TradingAgents-CN Webç•Œé¢                     â”‚
â”‚                    (ç«¯å£: 8501)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¤šæ™ºèƒ½ä½“åˆ†æç³»ç»Ÿ                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   è´¢åŠ¡æŒ‡æ ‡      â”‚   è¡Œä¸šå¯¹æ¯”      â”‚   ä¼°å€¼åˆ†æ      â”‚    â”‚
â”‚  â”‚    Agent       â”‚    Agent       â”‚    Agent       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚              æŠ¥å‘Šæ•´åˆAgent                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®å±‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   MongoDB   â”‚    Redis    â”‚      æ–‡ä»¶ç¼“å­˜           â”‚    â”‚
â”‚  â”‚  (27017)    â”‚   (6379)    â”‚                         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚            æ•°æ®æºé›†æˆ                                â”‚    â”‚
â”‚  â”‚      Tushare + AkShare + FinnHub                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                LLMå±‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  DashScope  â”‚  DeepSeek   â”‚     è‡ªå®šä¹‰OpenAPI       â”‚    â”‚
â”‚  â”‚  (é˜¿é‡Œäº‘)   â”‚  (æ€§ä»·æ¯”)   â”‚      æœ¬åœ°Ollama         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Dockeré…ç½®æ‰©å±•

### 1. å¢å¼ºçš„docker-compose.yml

é¡¹ç›®å·²æœ‰å®Œå–„çš„Dockeré…ç½®ï¼Œé’ˆå¯¹Aè‚¡åˆ†æåŠŸèƒ½çš„ä¼˜åŒ–å»ºè®®ï¼š

```yaml
# åœ¨ç°æœ‰docker-compose.ymlåŸºç¡€ä¸Šçš„ä¼˜åŒ–é…ç½®
version: '3.8'

services:
  # ä¸»è¦Webåº”ç”¨æœåŠ¡ (å·²é…ç½®å®Œå–„)
  web:
    build: .
    image: tradingagents-cn:latest
    container_name: TradingAgents-web
    ports:
      - "8501:8501"
    volumes:
      - .env:/app/.env
      - ./web:/app/web
      - ./tradingagents:/app/tradingagents
      - ./logs:/app/logs
      - ./config:/app/config
      - ./data:/app/data              # æ•°æ®ç›®å½•æŒä¹…åŒ–
      - ./cache:/app/cache            # ç¼“å­˜ç›®å½•æŒä¹…åŒ–
      - ./results:/app/results        # åˆ†æç»“æœæŒä¹…åŒ–
    environment:
      # Aè‚¡åˆ†æç‰¹å®šç¯å¢ƒå˜é‡
      TRADINGAGENTS_ANALYSIS_STOCK_ENABLED: "true"
      TRADINGAGENTS_DEFAULT_RESEARCH_LEVEL: "3"
      TRADINGAGENTS_MAX_CONCURRENT_ANALYSIS: "3"
      TRADINGAGENTS_CACHE_TTL_HOURS: "24"
      # èµ„æºé™åˆ¶
      TRADINGAGENTS_MAX_MEMORY_MB: "2048"
      TRADINGAGENTS_TOKEN_LIMIT_PER_REQUEST: "50000"
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 15s
      retries: 3
      start_period: 90s
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 3G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'

  # Aè‚¡åˆ†æä¸“ç”¨WorkeræœåŠ¡ (å¯é€‰æ‰©å±•)
  analysis-worker:
    build: .
    image: tradingagents-cn:latest
    container_name: TradingAgents-analysis-worker
    profiles:
      - analysis-worker
    volumes:
      - .env:/app/.env
      - ./tradingagents:/app/tradingagents
      - ./logs:/app/logs
      - ./data:/app/data
      - ./cache:/app/cache
      - ./results:/app/results
    environment:
      TRADINGAGENTS_WORKER_MODE: "true"
      TRADINGAGENTS_ANALYSIS_STOCK_ENABLED: "true"
      TRADINGAGENTS_MONGODB_URL: mongodb://admin:tradingagents123@mongodb:27017/tradingagents?authSource=admin
      TRADINGAGENTS_REDIS_URL: redis://:tradingagents123@redis:6379
    command: python -m tradingagents.workers.analysis_worker
    restart: unless-stopped
    depends_on:
      - mongodb
      - redis
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.0'

  # MongoDB (å·²é…ç½®å®Œå–„ï¼Œå¢åŠ ç´¢å¼•ä¼˜åŒ–)
  mongodb:
    image: mongo:4.4
    container_name: tradingagents-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: tradingagents123
      MONGO_INITDB_DATABASE: tradingagents
    volumes:
      - mongodb_data:/data/db
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
      - ./scripts/mongo-indexes.js:/docker-entrypoint-initdb.d/mongo-indexes.js:ro
    networks:
      - tradingagents-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongo localhost:27017/test --quiet
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    # MongoDBæ€§èƒ½ä¼˜åŒ–
    command: mongod --wiredTigerCacheSizeGB 1

  # Redis (å·²é…ç½®å®Œå–„ï¼Œå¢åŠ æŒä¹…åŒ–ä¼˜åŒ–)
  redis:
    image: redis:7-alpine
    container_name: tradingagents-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server 
      --appendonly yes 
      --requirepass tradingagents123
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - redis_data:/data
    networks:
      - tradingagents-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# æ–°å¢æ•°æ®å·
volumes:
  mongodb_data:
    driver: local
    name: tradingagents_mongodb_data
  redis_data:
    driver: local
    name: tradingagents_redis_data
  analysis_cache:
    driver: local
    name: tradingagents_analysis_cache
  analysis_results:
    driver: local
    name: tradingagents_analysis_results

networks:
  tradingagents-network:
    driver: bridge
    name: tradingagents-network
```

### 2. å¢å¼ºçš„Dockerfile

```dockerfile
# å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–çš„Dockerfile
FROM python:3.10-slim-bookworm as base

# è®¾ç½®å·¥ä½œç›®å½•å’ŒåŸºç¡€ç¯å¢ƒ
WORKDIR /app
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# ç³»ç»Ÿä¾èµ–å®‰è£…é˜¶æ®µ
FROM base as system-deps

# ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
RUN echo 'deb http://mirrors.aliyun.com/debian/ bookworm main' > /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian/ bookworm main' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian/ bookworm-updates main' >> /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian/ bookworm-updates main' >> /etc/apt/sources.list && \
    echo 'deb http://mirrors.aliyun.com/debian-security bookworm-security main' >> /etc/apt/sources.list && \
    echo 'deb-src http://mirrors.aliyun.com/debian-security bookworm-security main' >> /etc/apt/sources.list

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    wkhtmltopdf \
    xvfb \
    fonts-wqy-zenhei \
    fonts-wqy-microhei \
    fonts-liberation \
    pandoc \
    procps \
    htop \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Pythonä¾èµ–å®‰è£…é˜¶æ®µ
FROM system-deps as python-deps

# å®‰è£…uvåŒ…ç®¡ç†å™¨
RUN pip install -i https://mirrors.aliyun.com/pypi/simple uv

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt pyproject.toml ./

# å¤šæºè½®è¯¢å®‰è£…Pythonä¾èµ–
RUN set -e; \
    for src in \
        https://mirrors.aliyun.com/pypi/simple \
        https://pypi.tuna.tsinghua.edu.cn/simple \
        https://pypi.doubanio.com/simple \
        https://pypi.org/simple; do \
      echo "Try installing from $src"; \
      pip install --no-cache-dir -r requirements.txt -i $src && break; \
      echo "Failed at $src, try next"; \
    done

# åº”ç”¨æ„å»ºé˜¶æ®µ
FROM python-deps as app

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /app/data /app/logs /app/cache /app/results /app/config

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# å®‰è£…é¡¹ç›®æœ¬èº«
RUN pip install -e . --no-deps

# è®¾ç½®å¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash\nXvfb :99 -screen 0 1024x768x24 -ac +extension GLX &\nexport DISPLAY=:99\nexec "$@"' > /usr/local/bin/start-xvfb.sh \
    && chmod +x /usr/local/bin/start-xvfb.sh

# å¥åº·æ£€æŸ¥è„šæœ¬
COPY scripts/docker/healthcheck.sh /usr/local/bin/healthcheck.sh
RUN chmod +x /usr/local/bin/healthcheck.sh

# åˆ›å»ºérootç”¨æˆ·
RUN groupadd -r appuser && useradd -r -g appuser appuser
RUN chown -R appuser:appuser /app
USER appuser

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=15s --start-period=60s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh

EXPOSE 8501

CMD ["/usr/local/bin/start-xvfb.sh", "python", "-m", "streamlit", "run", "web/app.py", "--server.address=0.0.0.0", "--server.port=8501"]
```

## ç¯å¢ƒé…ç½®ç®¡ç†

### 1. åˆ†ç¯å¢ƒé…ç½®ç­–ç•¥

#### å¼€å‘ç¯å¢ƒ (.env.development)
```bash
# å¼€å‘ç¯å¢ƒé…ç½®
TRADINGAGENTS_ENV=development
TRADINGAGENTS_LOG_LEVEL=DEBUG
TRADINGAGENTS_ANALYSIS_STOCK_ENABLED=true

# æ•°æ®åº“é…ç½® (æœ¬åœ°)
MONGODB_ENABLED=false
REDIS_ENABLED=false
TRADINGAGENTS_CACHE_TYPE=file

# LLMé…ç½® (æœ¬åœ°ä¼˜å…ˆ)
LLM_PROVIDER=openai
OPENAI_BASE_URL=http://localhost:11434/v1
OPENAI_MODEL=llama3.1:8b

# æ€§èƒ½é…ç½® (å¼€å‘)
TRADINGAGENTS_MAX_CONCURRENT_ANALYSIS=1
TRADINGAGENTS_CACHE_TTL_HOURS=1
```

#### æµ‹è¯•ç¯å¢ƒ (.env.testing)
```bash
# æµ‹è¯•ç¯å¢ƒé…ç½®
TRADINGAGENTS_ENV=testing
TRADINGAGENTS_LOG_LEVEL=INFO
TRADINGAGENTS_ANALYSIS_STOCK_ENABLED=true

# æ•°æ®åº“é…ç½® (Docker)
MONGODB_ENABLED=true
REDIS_ENABLED=true
MONGODB_HOST=mongodb
REDIS_HOST=redis

# LLMé…ç½® (ç»æµå‹)
LLM_PROVIDER=deepseek
DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
DEEPSEEK_ENABLED=true

# æ€§èƒ½é…ç½® (æµ‹è¯•)
TRADINGAGENTS_MAX_CONCURRENT_ANALYSIS=2
TRADINGAGENTS_CACHE_TTL_HOURS=6
```

#### ç”Ÿäº§ç¯å¢ƒ (.env.production)
```bash
# ç”Ÿäº§ç¯å¢ƒé…ç½®
TRADINGAGENTS_ENV=production
TRADINGAGENTS_LOG_LEVEL=WARNING
TRADINGAGENTS_ANALYSIS_STOCK_ENABLED=true

# æ•°æ®åº“é…ç½® (Docker)
MONGODB_ENABLED=true
REDIS_ENABLED=true
MONGODB_HOST=mongodb
REDIS_HOST=redis

# LLMé…ç½® (ç”Ÿäº§çº§)
LLM_PROVIDER=dashscope
DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}

# æ€§èƒ½é…ç½® (ç”Ÿäº§)
TRADINGAGENTS_MAX_CONCURRENT_ANALYSIS=5
TRADINGAGENTS_CACHE_TTL_HOURS=24
TRADINGAGENTS_TOKEN_LIMIT_PER_REQUEST=30000

# ç›‘æ§é…ç½®
ENABLE_COST_TRACKING=true
COST_ALERT_THRESHOLD=500.0
USE_MONGODB_STORAGE=true
```

### 2. é…ç½®éªŒè¯è„šæœ¬

åˆ›å»ºé…ç½®éªŒè¯å·¥å…·ï¼š

```bash
# scripts/docker/validate-config.sh
#!/bin/bash
echo "ğŸ” éªŒè¯Dockerç¯å¢ƒé…ç½®..."

# æ£€æŸ¥å¿…éœ€çš„ç¯å¢ƒå˜é‡
required_vars=(
    "DASHSCOPE_API_KEY"
    "FINNHUB_API_KEY"
    "TUSHARE_TOKEN"
)

for var in "${required_vars[@]}"; do
    if [ -z "${!var}" ]; then
        echo "âŒ ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡: $var"
        exit 1
    else
        echo "âœ… $var å·²é…ç½®"
    fi
done

# æ£€æŸ¥æœåŠ¡è¿æ¥
echo "ğŸ” æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
python scripts/validation/check_system_status.py

echo "âœ… é…ç½®éªŒè¯å®Œæˆ"
```

## éƒ¨ç½²æ“ä½œæŒ‡å—

### 1. å¿«é€Ÿå¯åŠ¨è„šæœ¬

#### æ™ºèƒ½å¯åŠ¨è„šæœ¬ (scripts/docker/smart-deploy.sh)
```bash
#!/bin/bash
# Aè‚¡åˆ†æç³»ç»Ÿæ™ºèƒ½éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ TradingAgents-CN Aè‚¡åˆ†æç³»ç»Ÿéƒ¨ç½²"
echo "====================================="

# å‚æ•°è§£æ
ENVIRONMENT=${1:-production}
REBUILD=${2:-auto}
PROFILE=${3:-default}

echo "ğŸ“‹ éƒ¨ç½²å‚æ•°:"
echo "  ç¯å¢ƒ: $ENVIRONMENT"
echo "  é‡å»º: $REBUILD"
echo "  é…ç½®æ–‡ä»¶: $PROFILE"

# ç¯å¢ƒé…ç½®
case $ENVIRONMENT in
    "development")
        COMPOSE_FILE="docker-compose.yml:docker-compose.dev.yml"
        ENV_FILE=".env.development"
        ;;
    "testing")
        COMPOSE_FILE="docker-compose.yml:docker-compose.test.yml"
        ENV_FILE=".env.testing"
        ;;
    "production")
        COMPOSE_FILE="docker-compose.yml"
        ENV_FILE=".env.production"
        ;;
    *)
        echo "âŒ æœªçŸ¥ç¯å¢ƒ: $ENVIRONMENT"
        exit 1
        ;;
esac

# æ£€æŸ¥é…ç½®æ–‡ä»¶
if [ ! -f "$ENV_FILE" ]; then
    echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $ENV_FILE"
    echo "ğŸ’¡ è¯·åŸºäº.env.exampleåˆ›å»ºé…ç½®æ–‡ä»¶"
    exit 1
fi

# åŠ è½½ç¯å¢ƒé…ç½®
export $(cat $ENV_FILE | grep -v '^#' | xargs)

# é…ç½®éªŒè¯
echo "ğŸ” éªŒè¯é…ç½®..."
bash scripts/docker/validate-config.sh

# æ„å»ºå†³ç­–
if [ "$REBUILD" = "auto" ]; then
    if docker images | grep -q "tradingagents-cn"; then
        if git diff --quiet HEAD~1 HEAD -- . ':!*.md' ':!docs/'; then
            echo "ğŸ“¦ ä»£ç æ— å˜åŒ–ï¼Œè·³è¿‡æ„å»º"
            BUILD_FLAG=""
        else
            echo "ğŸ”„ æ£€æµ‹åˆ°ä»£ç å˜åŒ–ï¼Œé‡æ–°æ„å»º"
            BUILD_FLAG="--build"
        fi
    else
        echo "ğŸ—ï¸ é¦–æ¬¡éƒ¨ç½²ï¼Œæ„å»ºé•œåƒ"
        BUILD_FLAG="--build"
    fi
elif [ "$REBUILD" = "force" ]; then
    echo "ğŸ”„ å¼ºåˆ¶é‡æ–°æ„å»º"
    BUILD_FLAG="--build --no-cache"
else
    echo "ğŸ“¦ è·³è¿‡æ„å»º"
    BUILD_FLAG=""
fi

# éƒ¨ç½²æœåŠ¡
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
if [ "$PROFILE" = "analysis-worker" ]; then
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d $BUILD_FLAG --profile analysis-worker
else
    docker-compose -f $COMPOSE_FILE --env-file $ENV_FILE up -d $BUILD_FLAG
fi

# ç­‰å¾…æœåŠ¡å¯åŠ¨
echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
sleep 30

# å¥åº·æ£€æŸ¥
echo "ğŸ” å¥åº·æ£€æŸ¥..."
bash scripts/docker/health-check.sh

echo "âœ… éƒ¨ç½²å®Œæˆ!"
echo ""
echo "ğŸŒ è®¿é—®åœ°å€:"
echo "  Webåº”ç”¨: http://localhost:8501"
echo "  Redisç®¡ç†: http://localhost:8081"
echo "  MongoDBç®¡ç†: http://localhost:8082 (éœ€è¦--profile management)"
echo ""
echo "ğŸ“Š æŸ¥çœ‹æ—¥å¿—:"
echo "  docker-compose logs -f web"
echo "  docker-compose logs -f mongodb"
echo "  docker-compose logs -f redis"
```

#### å¥åº·æ£€æŸ¥è„šæœ¬ (scripts/docker/health-check.sh)
```bash
#!/bin/bash
# ç³»ç»Ÿå¥åº·æ£€æŸ¥è„šæœ¬

echo "ğŸ” ç³»ç»Ÿå¥åº·æ£€æŸ¥"
echo "=================="

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
echo "ğŸ“¦ æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
containers=("TradingAgents-web" "tradingagents-mongodb" "tradingagents-redis")

for container in "${containers[@]}"; do
    if docker ps --format "table {{.Names}}" | grep -q "$container"; then
        status=$(docker inspect --format='{{.State.Health.Status}}' "$container" 2>/dev/null || echo "no-healthcheck")
        if [ "$status" = "healthy" ] || [ "$status" = "no-healthcheck" ]; then
            echo "  âœ… $container: è¿è¡Œæ­£å¸¸"
        else
            echo "  âŒ $container: çŠ¶æ€å¼‚å¸¸ ($status)"
        fi
    else
        echo "  âŒ $container: æœªè¿è¡Œ"
    fi
done

# æ£€æŸ¥æœåŠ¡ç«¯å£
echo ""
echo "ğŸŒ æ£€æŸ¥æœåŠ¡ç«¯å£..."
ports=("8501:Webåº”ç”¨" "27017:MongoDB" "6379:Redis" "8081:Redisç®¡ç†")

for port_info in "${ports[@]}"; do
    IFS=':' read -r port name <<< "$port_info"
    if netstat -tln | grep -q ":$port "; then
        echo "  âœ… $name ($port): ç«¯å£å¼€æ”¾"
    else
        echo "  âŒ $name ($port): ç«¯å£å…³é—­"
    fi
done

# æ£€æŸ¥åº”ç”¨åŠŸèƒ½
echo ""
echo "ğŸ§ª æ£€æŸ¥åº”ç”¨åŠŸèƒ½..."

# Webåº”ç”¨å¥åº·æ£€æŸ¥
if curl -s -f http://localhost:8501/_stcore/health > /dev/null; then
    echo "  âœ… Webåº”ç”¨: å“åº”æ­£å¸¸"
else
    echo "  âŒ Webåº”ç”¨: å“åº”å¼‚å¸¸"
fi

# æ•°æ®åº“è¿æ¥æ£€æŸ¥
docker exec tradingagents-mongodb mongo --eval "db.adminCommand('ping')" > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "  âœ… MongoDB: è¿æ¥æ­£å¸¸"
else
    echo "  âŒ MongoDB: è¿æ¥å¤±è´¥"
fi

# Redisè¿æ¥æ£€æŸ¥
docker exec tradingagents-redis redis-cli ping > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "  âœ… Redis: è¿æ¥æ­£å¸¸"
else
    echo "  âŒ Redis: è¿æ¥å¤±è´¥"
fi

echo ""
echo "ğŸ¯ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ"
```

### 2. ä¸€é”®éƒ¨ç½²å‘½ä»¤

```bash
# å¼€å‘ç¯å¢ƒéƒ¨ç½²
./scripts/docker/smart-deploy.sh development auto

# æµ‹è¯•ç¯å¢ƒéƒ¨ç½²
./scripts/docker/smart-deploy.sh testing force

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² (å¸¦åˆ†æWorker)
./scripts/docker/smart-deploy.sh production auto analysis-worker

# å¿«é€Ÿé‡å¯
docker-compose restart web

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
docker-compose logs -f --tail=100 web
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å®¹å™¨èµ„æºé…ç½®

#### æ¨èé…ç½®è¡¨
| ç»„ä»¶ | CPU | å†…å­˜ | è¯´æ˜ |
|------|-----|------|------|
| Webåº”ç”¨ | 2æ ¸ | 3GB | ä¸»è¦åˆ†ææœåŠ¡ |
| MongoDB | 1æ ¸ | 1GB | æ•°æ®å­˜å‚¨ |
| Redis | 0.5æ ¸ | 512MB | ç¼“å­˜æœåŠ¡ |
| Analysis Worker | 1æ ¸ | 2GB | å¯é€‰åˆ†æé˜Ÿåˆ— |

#### èµ„æºé™åˆ¶é…ç½®
```yaml
# docker-compose.ymlä¸­çš„èµ„æºé…ç½®
deploy:
  resources:
    limits:
      memory: 3G
      cpus: '2.0'
    reservations:
      memory: 1G
      cpus: '0.5'
```

### 2. ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### MongoDBä¼˜åŒ–é…ç½®
```javascript
// scripts/mongo-indexes.js - MongoDBç´¢å¼•ä¼˜åŒ–
db = db.getSiblingDB('tradingagents');

// è‚¡ç¥¨æ•°æ®ç´¢å¼•
db.stock_data.createIndex({ 
    "symbol": 1, 
    "date": -1, 
    "data_source": 1 
});

// åˆ†æç»“æœç´¢å¼•
db.analysis_results.createIndex({ 
    "symbol": 1, 
    "analysis_date": -1, 
    "analysis_type": 1 
});

// TTLç´¢å¼• - è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ•°æ®
db.cache_data.createIndex(
    { "created_at": 1 }, 
    { expireAfterSeconds: 86400 * 7 } // 7å¤©è¿‡æœŸ
);

print("ç´¢å¼•åˆ›å»ºå®Œæˆ");
```

#### Redisä¼˜åŒ–é…ç½®
```bash
# Redisé…ç½®ä¼˜åŒ–
redis-server \
  --maxmemory 512mb \
  --maxmemory-policy allkeys-lru \
  --save 900 1 \
  --save 300 10 \
  --save 60 10000
```

### 3. å¹¶å‘å¤„ç†ä¼˜åŒ–

#### ç¯å¢ƒå˜é‡é…ç½®
```bash
# æ€§èƒ½è°ƒä¼˜ç¯å¢ƒå˜é‡
TRADINGAGENTS_MAX_CONCURRENT_ANALYSIS=3    # æœ€å¤§å¹¶å‘åˆ†ææ•°
TRADINGAGENTS_ANALYSIS_TIMEOUT=300         # åˆ†æè¶…æ—¶æ—¶é—´(ç§’)
TRADINGAGENTS_CACHE_TTL_HOURS=24          # ç¼“å­˜ç”Ÿå­˜æ—¶é—´
TRADINGAGENTS_MAX_MEMORY_MB=2048          # æœ€å¤§å†…å­˜ä½¿ç”¨
TRADINGAGENTS_WORKER_POOL_SIZE=4          # å·¥ä½œçº¿ç¨‹æ± å¤§å°
```

## ç›‘æ§å’Œè¿ç»´

### 1. æ—¥å¿—ç®¡ç†

#### æ—¥å¿—é…ç½®
```yaml
# docker-compose.ymlä¸­çš„æ—¥å¿—é…ç½®
logging:
  driver: "json-file"
  options:
    max-size: "100m"
    max-file: "5"
    compress: "true"
```

#### æ—¥å¿—æŸ¥çœ‹è„šæœ¬
```bash
# scripts/docker/view-logs.sh
#!/bin/bash

SERVICE=${1:-web}
LINES=${2:-100}

echo "ğŸ“‹ æŸ¥çœ‹ $SERVICE æœåŠ¡æ—¥å¿— (æœ€è¿‘ $LINES è¡Œ)"
echo "============================================"

case $SERVICE in
    "web"|"app")
        docker-compose logs -f --tail=$LINES web
        ;;
    "db"|"mongodb")
        docker-compose logs -f --tail=$LINES mongodb
        ;;
    "cache"|"redis")
        docker-compose logs -f --tail=$LINES redis
        ;;
    "all")
        docker-compose logs -f --tail=$LINES
        ;;
    *)
        echo "æ”¯æŒçš„æœåŠ¡: web, db, cache, all"
        ;;
esac
```

### 2. æ€§èƒ½ç›‘æ§

#### ç›‘æ§è„šæœ¬ (scripts/docker/monitor.sh)
```bash
#!/bin/bash
# ç³»ç»Ÿæ€§èƒ½ç›‘æ§è„šæœ¬

echo "ğŸ“Š TradingAgents-CN æ€§èƒ½ç›‘æ§"
echo "=============================="

# å®¹å™¨èµ„æºä½¿ç”¨
echo "ğŸ“¦ å®¹å™¨èµ„æºä½¿ç”¨:"
docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.MemPerc}}\t{{.NetIO}}" | grep tradingagents

# ç£ç›˜ä½¿ç”¨
echo ""
echo "ğŸ’¾ ç£ç›˜ä½¿ç”¨:"
docker system df

# æ•°æ®åº“çŠ¶æ€
echo ""
echo "ğŸ—„ï¸ æ•°æ®åº“çŠ¶æ€:"

# MongoDBçŠ¶æ€
mongo_stats=$(docker exec tradingagents-mongodb mongo --quiet --eval "
db.runCommand({serverStatus: 1}).connections
")
echo "MongoDBè¿æ¥æ•°: $mongo_stats"

# RedisçŠ¶æ€
redis_memory=$(docker exec tradingagents-redis redis-cli info memory | grep used_memory_human | cut -d: -f2)
redis_keys=$(docker exec tradingagents-redis redis-cli dbsize)
echo "Rediså†…å­˜ä½¿ç”¨: $redis_memory"
echo "Redisé”®æ•°é‡: $redis_keys"

# åº”ç”¨çŠ¶æ€
echo ""
echo "ğŸš€ åº”ç”¨çŠ¶æ€:"
python scripts/validation/check_system_status.py --brief
```

### 3. å¤‡ä»½å’Œæ¢å¤

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬ (scripts/docker/backup.sh)
```bash
#!/bin/bash
# æ•°æ®å¤‡ä»½è„šæœ¬

BACKUP_DIR="./backups/$(date +%Y%m%d_%H%M%S)"
mkdir -p "$BACKUP_DIR"

echo "ğŸ’¾ å¼€å§‹æ•°æ®å¤‡ä»½åˆ°: $BACKUP_DIR"

# MongoDBå¤‡ä»½
echo "ğŸ“„ å¤‡ä»½MongoDBæ•°æ®..."
docker exec tradingagents-mongodb mongodump \
    --host localhost:27017 \
    --username admin \
    --password tradingagents123 \
    --authenticationDatabase admin \
    --db tradingagents \
    --out /tmp/backup

docker cp tradingagents-mongodb:/tmp/backup "$BACKUP_DIR/mongodb"

# Rediså¤‡ä»½
echo "ğŸ“„ å¤‡ä»½Redisæ•°æ®..."
docker exec tradingagents-redis redis-cli --rdb /tmp/dump.rdb
docker cp tradingagents-redis:/tmp/dump.rdb "$BACKUP_DIR/redis.rdb"

# é…ç½®å¤‡ä»½
echo "ğŸ“„ å¤‡ä»½é…ç½®æ–‡ä»¶..."
cp .env "$BACKUP_DIR/"
cp docker-compose.yml "$BACKUP_DIR/"

# æ—¥å¿—å¤‡ä»½
echo "ğŸ“„ å¤‡ä»½æ—¥å¿—æ–‡ä»¶..."
cp -r logs "$BACKUP_DIR/" 2>/dev/null || true

echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
```

#### æ¢å¤è„šæœ¬ (scripts/docker/restore.sh)
```bash
#!/bin/bash
# æ•°æ®æ¢å¤è„šæœ¬

BACKUP_DIR=${1}

if [ -z "$BACKUP_DIR" ] || [ ! -d "$BACKUP_DIR" ]; then
    echo "âŒ è¯·æŒ‡å®šæœ‰æ•ˆçš„å¤‡ä»½ç›®å½•"
    echo "ç”¨æ³•: $0 <backup_directory>"
    exit 1
fi

echo "ğŸ”„ ä»å¤‡ä»½æ¢å¤: $BACKUP_DIR"

# åœæ­¢æœåŠ¡
echo "â¹ï¸ åœæ­¢æœåŠ¡..."
docker-compose down

# æ¢å¤MongoDB
if [ -d "$BACKUP_DIR/mongodb" ]; then
    echo "ğŸ“„ æ¢å¤MongoDBæ•°æ®..."
    docker-compose up -d mongodb
    sleep 10
    docker cp "$BACKUP_DIR/mongodb" tradingagents-mongodb:/tmp/
    docker exec tradingagents-mongodb mongorestore \
        --host localhost:27017 \
        --username admin \
        --password tradingagents123 \
        --authenticationDatabase admin \
        --drop \
        /tmp/mongodb
fi

# æ¢å¤Redis
if [ -f "$BACKUP_DIR/redis.rdb" ]; then
    echo "ğŸ“„ æ¢å¤Redisæ•°æ®..."
    docker cp "$BACKUP_DIR/redis.rdb" tradingagents-redis:/data/dump.rdb
fi

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
docker-compose up -d

echo "âœ… æ¢å¤å®Œæˆ"
```

### 4. æ•…éšœæ’é™¤æŒ‡å—

#### å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

| é—®é¢˜ | ç—‡çŠ¶ | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å†…å­˜ä¸è¶³ | å®¹å™¨OOM, åˆ†æå¤±è´¥ | å¢åŠ å†…å­˜é™åˆ¶ï¼Œä¼˜åŒ–Tokenä½¿ç”¨ |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | MongoDB/Redisè¿æ¥é”™è¯¯ | æ£€æŸ¥ç½‘ç»œé…ç½®ï¼Œé‡å¯æ•°æ®åº“æœåŠ¡ |
| APIé…é¢è¶…é™ | LLMè°ƒç”¨å¤±è´¥ | æ£€æŸ¥APIå¯†é’¥ï¼Œè°ƒæ•´å¹¶å‘æ•° |
| ç¼“å­˜é—®é¢˜ | æ•°æ®åŠ è½½ç¼“æ…¢ | æ¸…ç†ç¼“å­˜ï¼Œæ£€æŸ¥RedisçŠ¶æ€ |
| ç«¯å£å†²çª | æœåŠ¡å¯åŠ¨å¤±è´¥ | ä¿®æ”¹ç«¯å£æ˜ å°„ï¼Œæ£€æŸ¥ç«¯å£å ç”¨ |

#### æ•…éšœè¯Šæ–­è„šæœ¬ (scripts/docker/diagnose.sh)
```bash
#!/bin/bash
# æ•…éšœè¯Šæ–­è„šæœ¬

echo "ğŸ” TradingAgents-CN æ•…éšœè¯Šæ–­"
echo "============================"

# æ£€æŸ¥DockerçŠ¶æ€
echo "ğŸ³ Dockerç¯å¢ƒæ£€æŸ¥:"
docker --version
docker-compose --version
docker system df

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
echo ""
echo "ğŸ“¦ å®¹å™¨çŠ¶æ€æ£€æŸ¥:"
docker-compose ps

# æ£€æŸ¥ç½‘ç»œè¿æ¥
echo ""
echo "ğŸŒ ç½‘ç»œè¿æ¥æ£€æŸ¥:"
docker network ls | grep tradingagents

# æ£€æŸ¥æ—¥å¿—é”™è¯¯
echo ""
echo "ğŸ“‹ æœ€è¿‘é”™è¯¯æ—¥å¿—:"
docker-compose logs --tail=50 | grep -i error

# æ£€æŸ¥èµ„æºä½¿ç”¨
echo ""
echo "ğŸ“Š èµ„æºä½¿ç”¨æ£€æŸ¥:"
docker stats --no-stream

# æ£€æŸ¥ç¯å¢ƒé…ç½®
echo ""
echo "âš™ï¸ ç¯å¢ƒé…ç½®æ£€æŸ¥:"
python scripts/validation/check_system_status.py

echo ""
echo "ğŸ¯ è¯Šæ–­å®Œæˆ"
```

## æ€»ç»“

æœ¬éƒ¨ç½²æŒ‡å—æä¾›äº†TradingAgents-CNé¡¹ç›®Aè‚¡åˆ†æå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å®Œæ•´Dockeréƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. **å®Œæ•´çš„å®¹å™¨åŒ–æ¶æ„** - åŸºäºç°æœ‰DockeråŸºç¡€è®¾æ–½çš„ä¼˜åŒ–é…ç½®
2. **åˆ†ç¯å¢ƒé…ç½®ç®¡ç†** - å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å·®å¼‚åŒ–é…ç½®
3. **è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬** - ä¸€é”®éƒ¨ç½²å’Œæ™ºèƒ½æ„å»ºå†³ç­–
4. **æ€§èƒ½ä¼˜åŒ–ç­–ç•¥** - èµ„æºé™åˆ¶ã€ç¼“å­˜ä¼˜åŒ–ã€å¹¶å‘æ§åˆ¶
5. **å®Œå–„çš„ç›‘æ§è¿ç»´** - æ—¥å¿—ç®¡ç†ã€æ€§èƒ½ç›‘æ§ã€å¤‡ä»½æ¢å¤
6. **æ•…éšœæ’é™¤æŒ‡å—** - å¸¸è§é—®é¢˜è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆ

é€šè¿‡è¿™å¥—éƒ¨ç½²æ–¹æ¡ˆï¼Œå¯ä»¥å®ç°Aè‚¡åˆ†æå¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å¯é ã€é«˜æ•ˆã€å¯ç»´æŠ¤çš„å®¹å™¨åŒ–éƒ¨ç½²ã€‚